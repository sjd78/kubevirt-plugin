import { TFunction } from 'react-i18next';

import { V1VirtualMachine } from '@kubevirt-ui-ext/kubevirt-api/kubevirt';
import { RowMatchFilter } from '@openshift-console/dynamic-plugin-sdk';
import {
  isErrorPrintableStatus,
  printableVMStatus,
  VirtualMachineRowFilterType,
} from '@virtualmachines/utils';

const ErrorStatus = { id: 'Error', title: 'Error' };

export const statusFilterItems = [
  ...Object.keys(printableVMStatus).map((status) => ({
    id: status,
    title: status,
  })),
  ErrorStatus,
];

export const getStatusFilter = (t: TFunction): RowMatchFilter<V1VirtualMachine> => ({
  filter: (statuses, obj) => {
    const status = obj?.status?.printableStatus;
    const isError = statuses.selected.includes(ErrorStatus.id) && isErrorPrintableStatus(status);

    return statuses.selected?.length === 0 || statuses.selected?.includes(status) || isError;
  },
  filterGroupName: t('Status'),
  isMatch: (obj, filterStatus) => {
    return (
      filterStatus === obj?.status?.printableStatus ||
      (filterStatus === ErrorStatus.id && isErrorPrintableStatus(obj?.status?.printableStatus))
    );
  },
  items: statusFilterItems,
  type: VirtualMachineRowFilterType.Status,
});
